{% extends "base.html" %}
{% block content %}
<div class="container mt-5">

  <!-- Header -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">üìä Hasil Quiz: {{ quiz.title }}</h2>
    <p class="text-muted">Laporan hasil pengerjaan siswa & rekap nilai mingguan</p>
  </div>

  <!-- Card Daftar Nilai -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Daftar Nilai Siswa</h5>
    </div>
    <div class="card-body bg-light">
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle mb-0">
          <thead class="table-primary">
            <tr class="text-center">
              <th style="width:60px">No</th>
              <th>Nama Siswa</th>
              <th style="width:140px">Nilai</th>
              <th style="width:160px">Tanggal Pengerjaan</th>
            </tr>
          </thead>
          <tbody>
            {% if hasil_list %}
              {% for h in hasil_list %}
              <tr class="text-center">
                <td>{{ loop.index }}</td>
                <td class="text-start">{{ h.nama }}</td>
                <td>
                  <span class="badge bg-success fs-6">{{ "%.2f"|format(h.nilai) }}</span>
                </td>
                <td>{{ h.tanggal }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" class="text-center text-muted">Belum ada hasil quiz</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Diagram Nilai -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">Diagram Nilai Quiz</h5>
    </div>
    <div class="card-body bg-light">
      <canvas id="chartNilai" height="140"></canvas>
    </div>
  </div>

  <!-- Rekap Nilai per Minggu -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">üìÖ Rekap Nilai per Minggu</h5>
    </div>
    <div class="card-body bg-light">
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle mb-0">
          <thead class="table-warning text-center">
            <tr>
              <th style="width:140px">Tahun - Minggu</th>
              <th>Rata-rata Nilai</th>
              <th>Jumlah Peserta</th>
            </tr>
          </thead>
          <tbody>
            {% if rekap %}
              {% for r in rekap %}
              <tr class="text-center">
                <td>{{ r.tahun }} - W{{ r.minggu }}</td>
                <td><span class="badge bg-secondary fs-6">{{ "%.2f"|format(r.rata_rata) }}</span></td>
                <td>{{ r.jumlah }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted">Belum ada data rekap mingguan</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tombol Kembali -->
  <div class="text-center mb-5">
    <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-outline-secondary px-4">
      ‚¨ÖÔ∏è Kembali ke Dashboard
    </a>
  </div>

</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Template JSON aman -->
<script type="text/template" id="chart-data">
  {
    "labels": {{ labels | default([]) | tojson | safe }},
    "values": {{ values | default([]) | tojson | safe }}
  }
</script>

<script>
(function(){
  const template = document.getElementById("chart-data").textContent;
  const parsed = JSON.parse(template);
  const labels = parsed.labels || [];
  const dataVals = parsed.values || [];

  const canvas = document.getElementById('chartNilai');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  if (labels.length === 0 || dataVals.length === 0) return;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Nilai Siswa (%)',
        data: dataVals,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Distribusi Nilai Siswa' }
      },
      scales: {
        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Nilai (%)' } },
        x: { title: { display: true, text: 'Nama Siswa' } }
      }
    }
  });
})();
</script>




{% endblock %}
