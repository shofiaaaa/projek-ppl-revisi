{% extends 'base.html' %}
{% block content %}

<style>
.answer-btn {
  border-width: 2px;
  transition: all 0.2s ease-in-out;
}
.answer-btn:hover {
  background-color: #d1e7dd;
  border-color: #198754;
}
.answer-btn.active {
  background-color: #198754 !important;
  color: white !important;
}
</style>

<div class="container mt-4">
  <h3 class="fw-bold text-success">{{ quiz.title }}</h3>
  <p>Kode: <span class="badge bg-success">{{ quiz.code }}</span></p>

  <!-- TIMER -->
  <div id="timer" class="alert alert-warning fw-bold text-center"
       data-duration="{{ quiz.duration or 600 }}">
    ‚è≥ Menghitung waktu...
  </div>

  <form id="quizForm" method="POST" action="{{ url_for('submit_quiz', quiz_id=quiz.id) }}">

    {% if csrf_token %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}

    {% for q in questions %}
      <div class="card mb-4 shadow-sm">
        <div class="card-body">

          <p class="fw-semibold">{{ loop.index }}. {{ q.text }}</p>

          {% if q.image_filename %}
            <img src="{{ url_for('uploaded_file', filename=q.image_filename) }}"
                 width="200" class="rounded mb-2 d-block">
          {% endif %}

          <div class="d-grid gap-2">

            <!-- üî• CASE 1: Soal berasal dari model Choice -->
            {% if q.choices|length > 0 %}
              {% for c in q.choices %}
                <button type="button"
                        class="btn btn-outline-success answer-btn text-start"
                        data-question="{{ q.id }}" data-answer="{{ c.id }}">
                  {{ loop.index }}. {{ c.text }}
                </button>
              {% endfor %}

            <!-- üî• CASE 2: Soal lama pakai option_a‚Äìoption_d -->
            {% else %}
              {% if q.option_a %}
                <button type="button" class="btn btn-outline-success answer-btn text-start"
                        data-question="{{ q.id }}" data-answer="A">
                  A. {{ q.option_a }}
                </button>
              {% endif %}
              {% if q.option_b %}
                <button type="button" class="btn btn-outline-success answer-btn text-start"
                        data-question="{{ q.id }}" data-answer="B">
                  B. {{ q.option_b }}
                </button>
              {% endif %}
              {% if q.option_c %}
                <button type="button" class="btn btn-outline-success answer-btn text-start"
                        data-question="{{ q.id }}" data-answer="C">
                  C. {{ q.option_c }}
                </button>
              {% endif %}
              {% if q.option_d %}
                <button type="button" class="btn btn-outline-success answer-btn text-start"
                        data-question="{{ q.id }}" data-answer="D">
                  D. {{ q.option_d }}
                </button>
              {% endif %}
            {% endif %}

          </div>

        </div>
      </div>
    {% endfor %}

    <button type="submit" class="btn btn-success btn-lg w-100 mb-4">
      ‚úî Kumpulkan Jawaban
    </button>

  </form>
</div>

<script>
(function(){
  const timerDiv = document.getElementById('timer');
  const form = document.getElementById('quizForm');

  let duration = parseInt(timerDiv.dataset.duration, 10);
  if (!duration) duration = 600;

  function format(sec){
    const m = Math.floor(sec/60);
    const s = (sec%60).toString().padStart(2,"0");
    return `${m}:${s}`;
  }

  timerDiv.textContent = "‚è≥ Waktu tersisa: " + format(duration);

  const interval = setInterval(()=>{
    duration--;
    timerDiv.textContent = "‚è≥ Waktu tersisa: " + format(duration);

    if(duration <= 0){
      clearInterval(interval);
      alert("Waktu habis!");
      form.submit();
    }
  },1000);

  // click jawaban
  document.querySelectorAll(".answer-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const qid = btn.dataset.question;

      document.querySelectorAll(`.answer-btn[data-question="${qid}"]`)
        .forEach(x=>x.classList.remove("active"));

      btn.classList.add("active");

      let input = form.querySelector(`input[name="answer_${qid}"]`);
      if(!input){
        input = document.createElement("input");
        input.type = "hidden";
        input.name = `answer_${qid}`;
        form.appendChild(input);
      }

      input.value = btn.dataset.answer;
    });
  });
})();
</script>

{% endblock %}
